%
% Manipulation
%

\section {Planification de mouvement de manipulation}

\begin {frame} {Definitions}

A manipulation motion
\begin {itemize}
\item  is the motion of
  \begin {itemize}
  \item one or several robots and of
  \item one or several objects
  \end {itemize}
\pause
\item such that each object
  \begin{itemize}
  \item either is in a stable position, or
  \item is moved by one or several robots.
  \end {itemize}
\end {itemize}
\end {frame}

\begin {frame} {Composite robot}

Kinematic chain composed of each robot and of each object
\vskip .5cm
\centerline {
  \def\svgwidth {.6\linewidth}
                {\tiny
                  \graphicspath{{./figures/}}
                  \input {figures/composite-robot.pdf_tex}
                }
}
\pause
\vskip .5cm
The configuration space of a composite robot is the cartesian product of the configuration spaces of each robot and object.
$$
\CS = \CS_{r1}\times\CS_{r_{nb\ robots}}\times SE(3)^{nb\ objets}
$$
\end {frame}

%
%  Contraintes numÃ©riques
%
\begin {frame} {Numerical constraints}

Constraints to which manipulation motions are subject can be expressed numerically.
\begin{itemize}
\item Numerical constraints:
  $$f (\conf) = 0,\ \ \ \begin{array}{l}m\in\entiernaturel,\\ f\in C^1(\CS,\real^m)\end{array} $$
\item Parameterizable numerical constraints:
  $$f (\conf) = f_0,\ \ \ \begin{array}{l}m\in\entiernaturel,\\ f\in C^1(\CS,\real^m) \\ f_0\in\real^m\end{array} $$
\end{itemize}

\end{frame}

%
%  Exemple
%

\begin {frame} {Example: robot manipulating a ball}
\centerline {
  \parbox {.39\linewidth} {
    \centerline {
      \includegraphics [width=\linewidth] {pictures/ur5-grasp-ball.png}
    }
  }
  \parbox {.05\linewidth} {
    \vskip .5cm
  }
  \parbox {.55\linewidth} {
    \begin{align}
      \CS &= [-\pi,\pi]^6\times \real^3 \\
      \conf &= (q_0,\cdots,q_5,x_{b},y_{b},z_{b})
    \end{align}
    Two \textit{states}:
    \begin{itemize}
    \item \texttt{placement}: the ball is lying on the table,
    \item \texttt{grasp}: the ball is hold by the end-effector.
    \end {itemize}
  }
}
\end {frame}

%
%  Example
%

\begin {frame} {Example: robot manipulating a ball}
\centerline {
  \parbox {.39\linewidth} {
    \centerline {
      \includegraphics [width=\linewidth] {pictures/ur5-grasp-ball.png}
    }
  }
  \parbox {.05\linewidth} {
    \vskip .5cm
  }
  \parbox {.55\linewidth} {
    Each state is defined by a numerical constraint
    \begin{itemize}
    \item \texttt{placement}
      $$
      z_b = 0
      $$
    \pause\item \texttt{grasp}
      $$
      \x_{gripper} (q_0,\cdots,q_5) - \left(\begin{array}{l}x_b\\ y_b\\ z_b\end{array}\right) = 0
        $$
    \end {itemize}
  }
}
Each state is a sub-manifold of the configuration space
\end {frame}

%
%  Example
%

\begin {frame} {Example: robot manipulating a ball}

Motion constraints
\vskip .5cm
\centerline {
  \parbox {.39\linewidth} {
    \centerline {
      \includegraphics [width=\linewidth] {pictures/ur5-grasp-ball.png}
    }
  }
  \parbox {.05\linewidth} {
    \vskip .5cm
  }
  \parbox {.55\linewidth} {
    Two \textit{types of motion}:
    \begin{itemize}
    \item \texttt{transit}: the ball is lying and \textbf{fixed} on the table,
    \item \texttt{transfer}: the ball moves with the end-effector.
    \end {itemize}
  }
}
\end {frame}

%
%  Example
%

\begin {frame} {Example: robot manipulating a ball}

Motion constraints
\vskip .5cm
\centerline {
  \parbox {.39\linewidth} {
    \centerline {
      \includegraphics [width=\linewidth] {pictures/ur5-grasp-ball.png}
    }
  }
  \parbox {.05\linewidth} {
    \vskip .5cm
  }
  \parbox {.55\linewidth} {
    \begin{itemize}
    \item \texttt{transit}
      $$
      \begin{array}{lcl}
      \begin{array}{lcl}
        x_b &=& x_0 \\
        y_b &=& y_0 \\
      \end{array}& \left.\right\}&\mbox {parameterizable} \\
      \begin{array}{lcl}
        z_b = 0
      \end{array}&\left.\right\}& \mbox {simple}
      \end {array}
        $$
    \item \texttt{transfer}
      $$
      \x_{gripper} (q_0,\cdots,q_5) - \left(\begin{array}{l}x_b\\ y_b\\ z_b\end{array}\right) = 0
        $$
    \end {itemize}
  }
}
\end {frame}

%
%  Feuilletage
%

\begin {frame} {Foliation}
  Motion constraints define a foliation of the admissible configuration space (\texttt{grasp} $\cup$ \texttt{placement}).
  \begin{columns}
    \centering
    \column{0.5\textwidth}
    \def\svgwidth {\linewidth}
                  {\tiny
                    \graphicspath{{./figures/}}
                    \input {figures/foliation-example.pdf_tex}
                }
    \column{0.5\textwidth}
    \centering
    \begin{itemize}
    \item $f$: position of the ball
      $$L_{f}(f_1) = \left\{\conf\in\CS, f (\conf) = f_1 \right\}$$
    \item $g$: grasp of the ball
      $$L_{g}(0) = \left\{\conf\in\CS, g (\conf) = 0 \right\}$$
    \end{itemize}
  \end {columns}

\end {frame}

%
%  Feuilletage
%

\begin {frame} {Foliation}
  Motion constraints define a foliation of the admissible configuration space (\texttt{grasp} $\cup$ \texttt{placement}).
  \begin{columns}
    \centering
    \column{0.5\textwidth}
    \def\svgwidth {\linewidth}
                  {\tiny
                    \graphicspath{{./figures/}}
                    \input {figures/foliation-path.pdf_tex}
                }
    \column{0.5\textwidth}
    \centering
    Solution to a manipulation planning problem is a concatenation of \textit{transit} and \textit{transfer} paths.
  \end {columns}

\end {frame}

%
%  General case
%

\begin {frame} {General case}

  In a manipulation problem,
  \begin{itemize}
  \item the state of the system is subject to
    \begin {itemize}
      \item numerical constraints
    \end {itemize}
    \pause
  \item system trajectories are subject to
    \begin {itemize}
    \item numerical constraints
    \item parameterizable numerical constraints.
    \end {itemize}
  \end{itemize}
\end {frame}

%
%  General case
%

\begin {frame} {General case}

  \vskip .55cm
  In a manipulation problem,
  \begin{itemize}
  \item the state of the system is subject to
    \begin {itemize}
      \item numerical constraints
    \end {itemize}
  \item system trajectories are subject to
    \begin {itemize}
    \item \sout{numerical constraints}
    \item parameterizable numerical constraints, the dimension of the parameter being possibly less than the dimension of the constraint.
    \pause\item parameter value is constant along trajectories.
    \end {itemize}
  \end{itemize}
\end {frame}

%
%  Constraint graph
%

\begin {frame} {Constraint graph}
  A manipulation planning problem can be represented by a \textit{manipulation graph}.
  \begin {itemize}
    \item \textbf{Nodes} or \textit{states} are numerical constraints.
    \item \textbf{Edges} or \textit{transitions} are parameterizable numerical constraints.
  \end {itemize}
  \begin{center}
      \begin{tikzpicture}[>=stealth',auto,node distance=3.5cm,
        thick,main node/.style={circle,draw,text width=1.5cm,align=center,font=\footnotesize}]
        {\node[main node] (nh) {Placement};}
        {\node[main node] (h) [right of=nh] {Grasp};}
        {\path[->] (nh) edge[loop left] node[left, align=right] {Transit} (nh);}
        {\path[<-] (h) edge[bend right=45] node[above] {Grasp ball} (nh);}
        {\path[->] (h) edge[bend left=45] node[below] {Release ball} (nh);}
        {\path[->] (h) edge[loop right] node[right] {Transfer} (h);}
      \end{tikzpicture}
    \end{center}
\end {frame}

%
%  Projecting configuration on constraint
%

\begin {frame} {Projecting configuration on constraint}
  \begin {itemize}
  \item $\conf_0$ configuration,
  \item $f(\conf) = 0$ non-linear constraint,
  \item $\epsilon$ numerical tolerance
  \end {itemize}
  Projection ($\conf_0, f$):
  \begin{itemize}
    \item [] $\conf = \conf_0$; $\alpha = 0.95$
    \item [] for i from 1 to max\_iter:
      \begin {itemize}
      \item [] $\conf = \conf - \alpha \left(\frac {\partial f}{\partial \conf}(\conf)\right)^{+} f (\conf)$
      \item [] if $\|f(\conf)\| < \epsilon$: return $\conf$
      \end {itemize}
    \item [] return failure
  \end{itemize}

\end {frame}

%
%  Projecting path on constraint
%

\begin {frame} {Projecting path on constraint}
  \begin {itemize}
  \item $path$: mapping from $[0,1]$ to $\CS$
  \item $f(\conf) = 0$ non-linear constraint,
  \item $\epsilon$ numerical tolerance
  \end {itemize}
  Projection ($path$, $f$):
  \begin{itemize}
    \item [] if $\|f(path (0))\| > \epsilon$ or $\|f(path (1))\| > \epsilon$:
      \begin {itemize}
      \item [] return failure
      \end {itemize}

  \end{itemize}

\end {frame}

%
%  Exploration de l'espaces des configurations admissibles
%

\begin{frame}[fragile]{Algorithm}{Manipulation RRT}
%-------------------------------------------------------
  \begin{columns}
    \column{0.3\textwidth}
    \includegraphics<1>[width=\textwidth,height=\textheight,keepaspectratio]{img/mrrt/foliation-project-seq-1.png}
    \includegraphics<2-3>[width=\textwidth,height=\textheight,keepaspectratio]{img/mrrt/foliation-project-seq-2.png}
    \includegraphics<4>[width=\textwidth,height=\textheight,keepaspectratio]{img/mrrt/foliation-project-seq-3.png}
    \includegraphics<5>[width=\textwidth,height=\textheight,keepaspectratio]{img/mrrt/foliation-project-seq-4.png}
    \includegraphics<6>[width=\textwidth,height=\textheight,keepaspectratio]{img/mrrt/foliation-project-seq-5.png}
    \includegraphics<7->[width=\textwidth,height=\textheight,keepaspectratio]{img/mrrt/foliation-project-seq-5.png}
    \column{0.7\textwidth}
    \begin{block}{Manipulation RRT}
      \setbeamertemplate{itemize item}{}% Remove bullets frp, ote,oze sinote,
      \setlength\leftmargini{0em}
      \begin{itemize}[leftmargin=*]
        \item<1-> $\conf_{rand}$ = shoot\_random\_config()
        \item <2-> for each connected component:
          \setlength\leftmargin{0em}
          \begin{itemize}[leftmargin=*]
          \item[]<2-> $\conf_{near}$ = nearest\_neighbour($\conf_{rand}$, $roadmap$)
          \item[]<3-> $e$ = select\_transition($\conf_{near}$)
          \item[]<4-> $\conf_{proj}$ = generate\_target\_config($\conf_{near},\conf_{rand}$, $e$)
          \item[]<5-> $\conf_{new}$ = extend($\conf_{near}$, $\conf_{proj}$, edge)
          \item[]<6-> $roadmap$.insert\_node($\conf_{new}$)
          \item[]<7-> $roadmap$.insert\_edge(e, $\conf_{near}$, $\conf_{new}$)
          \item[]<7-> new\_nodes.append ($\conf_{new}$)
          \end{itemize}
        \item <8-> for $(\conf_0,\conf_1)\in \mbox{pairs} (\conf_{new}^1, ..., \conf_{new}^{n_{cc}})$:
          \begin{itemize}
            \item[]<9-> connect (roadmap, $\conf_0,\conf_1$)
          \end{itemize}
      \end{itemize}
    \end{block}
  \end{columns}
\end{frame}

%
%  Select transition
%

\begin {frame} {Select transition}

  $e$ = select\_transition($\conf_{near}$)
  \vskip .5cm

  Outward edges of each node are given a probability distribution. The transition from a node to another node is chosen by random sampling.
  \begin{center}
      \begin{tikzpicture}[>=stealth',auto,node distance=3.5cm,
        thick,main node/.style={circle,draw,text width=1.5cm,align=center,font=\footnotesize}]
        {\node[main node] (nh) {Placement};}
        {\node[main node] (h) [right of=nh] {Grasp};}
        {\path[->] (nh) edge[loop left] node[left, align=right] {Transit} (nh);}
        {\path[<-] (h) edge[bend right=45] node[above] {Grasp ball} (nh);}
        {\path[->] (h) edge[bend left=45] node[below] {Release ball} (nh);}
        {\path[->] (h) edge[loop right] node[right] {Transfer} (h);}
      \end{tikzpicture}
    \end{center}
\end {frame}

%
%  Generate target configuration
%

\begin {frame} {Generate target configuration}

$\conf_{proj}$ = generate\_target\_config($\conf_{near},\conf_{rand}$, $e$)
\vskip .5cm
Once edge $e$ has been selected, $\conf_{rand}$ is \textit {projected} onto the destination node $n_{dest}$ in a configuration reachable by $\conf_{near}$.
\begin{align*}
  f_{e} (\conf_{proj}) &= f_{e} (\conf_{near})\\
  f_{dest} (\conf_{proj}) &= 0
\end{align*}
\end {frame}

%
%  Extend
%

\begin {frame} {Extend}

$\conf_{new}$ = extend($\conf_{near}$, $\conf_{proj}$, edge)
\vskip.5cm
\textit {Project} straight path $[\conf_{near},\conf_{proj}]$ on edge constraint:
\begin {itemize}
\item if projection successful and projected path collision free
$$
\conf_{new} \leftarrow \conf_{proj}
$$
\pause
\item otherwise $(\conf_{near},\conf_{new})\leftarrow$ largest path interval tested as collision-free with successful projection.
\end {itemize}
\pause
$$
\forall \conf\in(\conf_{near},\conf_{new}),\ f_{e} (\conf) = f_{e}(\conf_{near})
$$
\end {frame}

%
%  Connect
%

\begin {frame} {Connect}

connect (roadmap, $\conf_0,\conf_1$):
\begin{itemize}
  \item [] $s_0$ = state ($\conf_0$)
  \item [] $s_1$ = state ($\conf_1$)
  \item [] e = transition ($n_0$, $n_1$)
  \item [] if e and $f_{e} (\conf_0) == f_{e} (\conf_1)$:
    \begin {itemize}
    \item [] if p = projected\_path (e, $\conf_0$, $\conf_1$) collision-free:
      \begin {itemize}
        \item [] roadmap.insert\_edge (e, $\conf_0$,$\conf_1$)
      \end {itemize}
    \end {itemize}
  \item [] return
\end{itemize}

\end {frame}

%
%  Connecting trees
%

\begin {frame} {Connecting trees}
Manipulation RRT is initialized with $\conf_{init}$, $\conf_{goal}$.
\begin {itemize}
\item 2 connected components.
\item possible connection.
\end {itemize}
\centerline {
  \def\svgwidth {\linewidth}
                {
                  \graphicspath{{./figures/}}
                  \input {figures/connecting-trees-simple-grasp.pdf_tex}
                }
}
\end{frame}

%
%  Connecting trees general case
%

\begin {frame} {Connecting trees: general case}
Manipulation RRT is initialized with $\conf_{init}$, $\conf_{goal}$.
\begin {itemize}
\item 2 connected components,
\item no possible connection.
\end {itemize}
\centerline {
  \def\svgwidth {\linewidth}
                {
                  \graphicspath{{./figures/}}
                  \input {figures/connecting-trees.pdf_tex}
                }
}
\end{frame}

%
%  Connecting trees general case
%

\begin {frame} {Connecting trees: general case}
Manipulation RRT is initialized with $\conf_{init}$, $\conf_{goal}$.
\begin {itemize}
\item 2 connected components,
\item no possible connection.
\end {itemize}
\begin {columns}
\column {.5\textwidth}
\centerline {
  \def\svgwidth {\linewidth}
                {\tiny
                  \graphicspath{{./figures/}}
                  \input {figures/connecting-trees.pdf_tex}
                }
}
\column {.5\textwidth}
  \begin{center}
    \tiny
      \begin{tikzpicture}[>=stealth',auto,node distance=1.75cm,
        thick,main node/.style={circle,draw,text width=.75cm,align=center,font=\tiny}]
        {\node[main node] (nh) {Placement};}
        {\node[main node] (h) [right of=nh] {Grasp};}
        {\path[->] (nh) edge[loop left] node[left, align=right] {Transit} (nh);}
        {\color{red}\path[<-] (h) edge[bend right=22.5] node[above] {Grasp ball} (nh);}
        {\path[->] (h) edge[bend left=22.5] node[below] {Release ball} (nh);}
        {\path[->] (h) edge[loop right] node[right] {Transfer} (h);}
      \end{tikzpicture}
    \end{center}
\end {columns}
\end{frame}

%
%  Relative positions as numerical constraints
%

\begin {frame} {Relative positions as numerical constraints}

Let $T_1 = T_{(R_1,t_1)}$ and $T_2 = T_{(R_2,t_2)}$ be two rigid-body transformations. The relative transformation $T_{2/1} = T_1^{-1}\circ T_2$ can be represented by a vector of dimension 6:
$$
\left(\begin{array}{c} \mathbf{u} \\ \mathbf {v}\end{array}\right)
$$
where
\begin {columns}
\column {.5\textwidth}
$$
\mathbf{u} = R_1^T (t_2-t_1)
$$
\column {.5\textwidth}
$R_1^T R_2$ is the matrix of the rotation around axis $\mathbf{v}/\|\mathbf {v}\|$ and of angles $\|\mathbf {v}\|$.
\end {columns}
\end {frame}
